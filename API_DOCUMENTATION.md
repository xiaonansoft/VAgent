# Backend API Documentation / 后端 API 文档

This document describes the backend API endpoints and data models for the Vanadium Smelting Agent Prototype.
本文档描述了钒冶炼智能体原型的后端 API 端点和数据模型。

## Base URL / 基础 URL
The API is served at `http://localhost:8000` (default).
API 默认运行在 `http://localhost:8000`。

## REST API Endpoints / REST API 端点

### 1. System Health / 系统健康检查
- **Endpoint**: `GET /api/health`
- **Description**: Checks if the backend server is running.
  **描述**: 检查后端服务器是否正在运行。
- **Response**: `{"ok": True}`

### 2. Chat Interface / 对话接口
- **Endpoint**: `POST /api/chat`
- **Description**: Main entry point for the AI Copilot. Processes user messages and context to generate responses and tool calls.
  **描述**: AI Copilot 的主要入口点。处理用户消息和上下文以生成响应和工具调用。
- **Request Body**: `ChatRequest`
  - `message` (str): User's input message.
    用户输入的消息。
  - `iron_temp_c` (float, optional): Current iron temperature.
    当前铁水温度。
  - `si_content_pct` (float, optional): Silicon content percentage.
    硅含量百分比。
  - `is_one_can` (bool, optional): Whether "One-Can" process is used.
    是否使用“一罐到底”工艺。
- **Response**: `ChatResponse`
  - `reply` (str): The AI's text response.
    AI 的文本响应。
  - `tool_calls` (list): List of tool calls generated by the AI agent.
    AI 智能体生成的工具调用列表。

### 3. Real-time Data Stream (SSE) / 实时数据流 (SSE)
- **Endpoint**: `GET /api/stream`
- **Description**: Server-Sent Events (SSE) stream for real-time process data.
  **描述**: 用于实时过程数据的服务器发送事件 (SSE) 流。
- **Format**: `text/event-stream`
- **Payload**: JSON object containing:
  **负载**: 包含以下内容的 JSON 对象：
  - `process_time`: Current simulation time (min).
    当前仿真时间 (分钟)。
  - `temperature`: Current temperature value and status.
    当前温度值和状态。
  - `chemistry`: Chemical composition (Si, V, C).
    化学成分 (硅, 钒, 碳)。
  - `lance_height`: Lance height data.
    枪位数据。
  - `model_params`: Self-learning parameters.
    自学习参数。

### 4. Process State / 过程状态
- **Endpoint**: `GET /api/state`
- **Description**: Snapshot of the current simulation state.
  **描述**: 当前仿真状态的快照。
- **Response**:
  - `temperature_c` (float): Current temperature.
    当前温度。
  - `lance_height_mm` (float): Current lance height.
    当前枪位。

### 5. Heat Confirmation (Data Loop) / 炉次确认 (数据闭环)
- **Endpoint**: `POST /api/heat/confirm`
- **Description**: Confirms heat results and feeds data back for model self-learning.
  **描述**: 确认炉次结果并将数据反馈给模型进行自学习。
- **Request Body**: `SaveHeatResultsInputs`
- **Response**: Status and count of learned entries.
  状态和已学习条目的数量。

---

## MCP Tools (JSON-RPC) / MCP 工具 (JSON-RPC)

The backend implements the Model Context Protocol (MCP) via JSON-RPC at `/mcp/tools`.
后端通过 JSON-RPC 在 `/mcp/tools` 实现了模型上下文协议 (MCP)。

### 1. calculate_initial_charge / 计算初始配料
- **Description**: L1 Static Model. Calculates initial charge recipe and oxygen volume based on iron conditions.
  **描述**: L1 静态模型。根据铁水条件计算初始配料单和总氧量。
- **Input**: `InitialChargeInputs` (Iron weight, temp, analysis, target temp).
  **输入**: 铁水重量、温度、成分分析、目标温度。
- **Output**: `InitialChargeResult` (Recipe, Oxygen total, Slag weight, Warnings).
  **输出**: 配料单、总氧量、渣量、警告信息。

### 2. simulate_blow_path / 仿真吹炼路径
- **Description**: L2 Dynamic Model. Simulates the chemical and thermal evolution of the molten bath over time using ODEs.
  **描述**: L2 动态模型。使用常微分方程 (ODEs) 模拟熔池随时间的化学和热演变。
- **Input**: `SimulationInputs` (Initial conditions, recipe, duration).
  **输入**: 初始条件、配料、持续时间。
- **Output**: `SimulationResult` (Time-series points for Temp, C, Si, V, Ti).
  **输出**: 温度、碳、硅、钒、钛的时间序列点。

### 3. diagnose_process_quality / 诊断过程质量
- **Description**: Post-process diagnosis. Evaluates vanadium slag grade and yield.
  **描述**: 过程后诊断。评估钒渣品位和收得率。
- **Input**: `SlagAnalysis`, `ProcessData`, `IronInitialAnalysis`.
  **输入**: 渣分析、过程数据、铁水初始分析。
- **Output**: `DiagnoseLowYieldResult` (Findings, Severity, Recommendations).
  **输出**: 发现、严重程度、建议。

### 4. calculate_thermal_balance / 计算热平衡
- **Description**: Thermal balance calculation and coolant recommendation.
  **描述**: 热平衡计算和冷却剂推荐。
- **Input**: `ThermalBalanceInputs` (Iron temp, Si content).
  **输入**: 铁水温度、硅含量。
- **Output**: `CoolantRecommendation` (Coolant type, Amount kg/t, Timing).
  **输出**: 冷却剂类型、数量 (kg/t)、时机。

### 5. recommend_lance_profile / 推荐枪位曲线
- **Description**: Generates a lance height control strategy based on silicon content.
  **描述**: 根据硅含量生成枪位控制策略。
- **Input**: `si_content_pct` (float).
  **输入**: 硅含量百分比。
- **Output**: `LanceProfile` (Mode, Steps, Endgame action).
  **输出**: 模式、步骤、终点操作。

### 6. predict_critical_temp / 预测临界温度
- **Description**: Predicts the critical temperature (Tc) where Carbon oxidation overtakes Vanadium oxidation.
  **描述**: 预测碳氧化超过钒氧化的临界温度 (Tc)。
- **Input**: `v_content_pct`, `current_temp_c`.
  **输入**: 钒含量百分比、当前温度。
- **Output**: `CriticalTempResult` (Tc, Margin).
  **输出**: 临界温度 Tc、余量。

---

## Data Models (Schemas) / 数据模型 (模式)

### IronInitialAnalysis / 铁水初始分析
- `C`, `Si`, `V`, `Ti`, `P`, `S`: Composition percentages (float).
  成分百分比 (浮点数)。

### InitialChargeInputs / 初始配料输入
- `iron_weight_t`: Iron weight (tons).
  铁水重量 (吨)。
- `iron_temp_c`: Iron temperature (°C).
  铁水温度 (°C)。
- `iron_analysis`: `IronInitialAnalysis`.
  铁水分析。
- `is_one_can`: Boolean flag for process type.
  工艺类型的布尔标志。
- `target_temp_c`: Target end temperature.
  目标终点温度。

### SimulationInputs / 仿真输入
- `initial_temp_c`: Starting temperature.
  起始温度。
- `initial_analysis`: `IronInitialAnalysis`.
  初始分析。
- `recipe`: Dictionary of added materials (name -> tons).
  添加材料的字典 (名称 -> 吨)。
- `oxygen_flow_rate_m3h`: Oxygen flow rate.
  氧气流量。
- `duration_s`: Simulation duration in seconds.
  仿真持续时间 (秒)。

### ProcessData / 过程数据
- `tap_time_min`: Tapping time.
  出钢时间。
- `coolant_type_used`: Type of coolant used.
  使用的冷却剂类型。
- `events`: List of process events.
  过程事件列表。
